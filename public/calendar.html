<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>캘린더</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container mt-5">
      <!-- 월/연도 선택 -->
      <div class="d-flex justify-content-between align-items-center">
        <h2 id="month-year"></h2>
        <div>
          <button class="btn btn-outline-secondary" id="prevMonthBtn">
            &lt;
          </button>
          <button class="btn btn-primary" id="todayBtn">Today</button>
          <button class="btn btn-outline-secondary" id="nextMonthBtn">
            &gt;
          </button>
        </div>
      </div>

      <!-- 달력 표시 영역 -->
      <div id="calendar" class="mt-3"></div>

      <!-- 일정 추가 버튼 -->
      <button
        class="btn btn-primary mt-3"
        data-bs-toggle="modal"
        data-bs-target="#addEventModal"
      >
        일정 추가
      </button>

      <!-- 일정 추가 모달 -->
      <div
        class="modal fade"
        id="addEventModal"
        tabindex="-1"
        aria-labelledby="addEventModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addEventModalLabel">일정 추가</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="event-title" class="form-label">일정 제목</label>
                <input
                  type="text"
                  class="form-control"
                  id="event-title"
                  placeholder="일정 제목"
                />
              </div>
              <div class="mb-3">
                <label for="event-date" class="form-label">날짜</label>
                <input type="date" class="form-control" id="event-date" />
              </div>
              <div class="mb-3">
                <label for="start-time" class="form-label">시작 시간</label>
                <input type="time" class="form-control" id="start-time" />
              </div>
              <div class="mb-3">
                <label for="end-time" class="form-label">종료 시간</label>
                <input type="time" class="form-control" id="end-time" />
              </div>
              <div class="mb-3">
                <label for="exercises" class="form-label">운동 종목</label>
                <input
                  type="text"
                  class="form-control"
                  id="exercises"
                  placeholder="운동 종목 (쉼표로 구분)"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                닫기
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="saveEvent()"
              >
                저장
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 일정 삭제 버튼 -->
      <button
        class="btn btn-danger mt-3"
        id="deleteEventBtn"
        onclick="deleteEvent()"
      >
        일정 삭제
      </button>
    </div>

    <style>
      #calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* 7일의 열 생성 */
        gap: 5px;
      }
      .day {
        border: 1px solid #ddd;
        padding: 10px;
        height: 100px;
        position: relative;
      }
      .day-number {
        font-weight: bold;
        position: absolute;
        top: 5px;
        left: 5px;
      }
      .event {
        margin-top: 20px;
        background-color: #f9f9f9;
        padding: 3px;
        border-radius: 3px;
        font-size: 0.8em;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let userId;

      // 페이지 로드 시 서버에서 세션을 통해 userId를 받아옴
      window.onload = function () {
        axios
          .get("/api/users/me")
          .then((response) => {
            userId = response.data.userId;
            generateCalendar(); // 달력 생성
          })
          .catch((error) => {
            console.error("User ID를 불러오는 중 오류가 발생했습니다.", error);
            alert("로그인이 필요합니다.");
            window.location.href = "/login.html"; // 로그인 페이지로 이동
          });
      };

      // 달력 생성 함수
      function generateCalendar() {
        const calendar = document.getElementById("calendar");
        calendar.innerHTML = ""; // 기존 달력 초기화

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 이번 달 첫 요일
        const daysInMonth = new Date(year, month + 1, 0).getDate(); // 이번 달 마지막 날짜

        // 빈 셀 추가 (첫 번째 요일 전까지)
        for (let i = 0; i < firstDayOfMonth; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.classList.add("day");
          calendar.appendChild(emptyCell);
        }

        // 날짜 셀 생성
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCell = document.createElement("div");
          dayCell.classList.add("day");

          const dayNumber = document.createElement("div");
          dayNumber.classList.add("day-number");
          dayNumber.textContent = day;
          dayCell.appendChild(dayNumber);

          calendar.appendChild(dayCell);
        }

        loadEvents(); // 일정 불러오기
      }

      // 일정 저장
      function saveEvent() {
        const title = document.getElementById("event-title").value;
        const date = document.getElementById("event-date").value;
        const startTime = document.getElementById("start-time").value;
        const endTime = document.getElementById("end-time").value;
        const exercises = document.getElementById("exercises").value.split(",");

        if (title && date && startTime && endTime) {
          axios
            .post("/api/events", {
              title,
              date,
              startTime,
              endTime,
              exercises,
              userId,
            })
            .then((response) => {
              if (response.data.success) {
                alert("일정이 저장되었습니다.");
                generateCalendar(); // 저장 후 일정 새로고침
              } else {
                alert("일정 저장에 실패했습니다.");
              }
            })
            .catch((error) => {
              console.error(error);
              alert("일정 저장 중 오류가 발생했습니다.");
            });
        } else {
          alert("모든 필드를 입력해주세요.");
        }
      }

      // 일정 삭제
      function deleteEvent(eventId) {
        axios
          .delete(`/api/events/${eventId}`)
          .then((response) => {
            if (response.data.success) {
              alert("일정이 삭제되었습니다.");
              generateCalendar(); // 삭제 후 일정 새로고침
            } else {
              alert("일정 삭제에 실패했습니다.");
            }
          })
          .catch((error) => {
            console.error(error);
            alert("일정 삭제 중 오류가 발생했습니다.");
          });
      }

      // 서버에서 일정 불러오기
      function loadEvents() {
        axios
          .get(`/api/events?userId=${userId}`)
          .then((response) => {
            const events = response.data.events;
            displayEvents(events);
          })
          .catch((error) => {
            console.error("일정 불러오기 중 오류가 발생했습니다.", error);
            alert("일정 불러오기 중 오류가 발생했습니다.");
          });
      }

      // 일정 달력에 표시
      function displayEvents(events) {
        events.forEach((event) => {
          const eventDate = new Date(event.date);
          const day = eventDate.getDate();
          const dayCells = document.querySelectorAll(".day");

          dayCells.forEach((cell) => {
            const dayNumber = cell.querySelector(".day-number");
            if (dayNumber && parseInt(dayNumber.textContent) === day) {
              const eventEl = document.createElement("div");
              eventEl.classList.add("event");
              eventEl.textContent = event.title;
              cell.appendChild(eventEl); // 셀 안에 일정 표시
            }
          });
        });
      }
    </script>
  </body>
</html>
