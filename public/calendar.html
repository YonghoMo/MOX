<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>캘린더</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <!-- 월/연도 선택 -->
      <div class="d-flex justify-content-between align-items-center">
        <h2 id="month-year"></h2>
        <div>
          <button class="btn btn-outline-secondary" id="prevMonthBtn">
            &lt;
          </button>
          <button class="btn btn-primary" id="todayBtn">Today</button>
          <button class="btn btn-outline-secondary" id="nextMonthBtn">
            &gt;
          </button>
        </div>
      </div>

      <!-- 일정 표시 영역 -->
      <div id="calendar" class="mt-3"></div>

      <!-- 일정 추가 버튼 -->
      <button
        class="btn btn-primary mt-3"
        data-bs-toggle="modal"
        data-bs-target="#addEventModal"
      >
        일정 추가
      </button>

      <!-- 일정 추가 모달 -->
      <div
        class="modal fade"
        id="addEventModal"
        tabindex="-1"
        aria-labelledby="addEventModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addEventModalLabel">일정 추가</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="event-title" class="form-label">일정 제목</label>
                <input
                  type="text"
                  class="form-control"
                  id="event-title"
                  placeholder="일정 제목"
                />
              </div>
              <div class="mb-3">
                <label for="event-date" class="form-label">날짜</label>
                <input type="date" class="form-control" id="event-date" />
              </div>
              <div class="mb-3">
                <label for="start-time" class="form-label">시작 시간</label>
                <input type="time" class="form-control" id="start-time" />
              </div>
              <div class="mb-3">
                <label for="end-time" class="form-label">종료 시간</label>
                <input type="time" class="form-control" id="end-time" />
              </div>
              <div class="mb-3">
                <label for="exercises" class="form-label">운동 종목</label>
                <input
                  type="text"
                  class="form-control"
                  id="exercises"
                  placeholder="운동 종목 (쉼표로 구분)"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                닫기
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="saveEvent()"
              >
                저장
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 일정 삭제 버튼 -->
      <button
        class="btn btn-danger mt-3"
        id="deleteEventBtn"
        onclick="deleteEvent()"
      >
        일정 삭제
      </button>
    </div>

    <!-- 부트스트랩 및 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let userId; // 전역 변수로 선언

      // 페이지 로드 시 서버에서 세션을 통해 userId를 받아옴
      window.onload = function () {
        axios
          .get("/api/users/me")
          .then((response) => {
            userId = response.data.userId; // 서버에서 가져온 userId를 전역 변수에 저장
            loadEvents(userId); // 일정 불러오기 함수에 userId 전달
          })
          .catch((error) => {
            console.error("User ID를 불러오는 중 오류가 발생했습니다.", error);
            alert("로그인이 필요합니다.");
            window.location.href = "/login.html"; // 로그인이 필요하면 로그인 페이지로 리디렉션
          });
      };

      // 일정 저장
      function saveEvent() {
        const title = document.getElementById("event-title").value;
        const date = document.getElementById("event-date").value;
        const startTime = document.getElementById("start-time").value;
        const endTime = document.getElementById("end-time").value;
        const exercises = document.getElementById("exercises").value.split(",");

        if (title && date && startTime && endTime) {
          axios
            .post("/api/events", {
              title,
              date,
              startTime,
              endTime,
              exercises,
              userId, // 서버에서 받아온 userId를 사용
            })
            .then((response) => {
              if (response.data.success) {
                alert("일정이 저장되었습니다.");
                loadEvents(userId); // 저장 후 일정 새로고침
              } else {
                alert("일정 저장에 실패했습니다.");
              }
            })
            .catch((error) => {
              console.error(error);
              alert("일정 저장 중 오류가 발생했습니다.");
            });
        } else {
          alert("모든 필드를 입력해주세요.");
        }
      }

      // 일정 삭제
      function deleteEvent(eventId) {
        axios
          .delete(`/api/events/${eventId}`)
          .then((response) => {
            if (response.data.success) {
              alert("일정이 삭제되었습니다.");
              loadEvents(userId); // 삭제 후 일정 새로고침
            } else {
              alert("일정 삭제에 실패했습니다.");
            }
          })
          .catch((error) => {
            console.error(error);
            alert("일정 삭제 중 오류가 발생했습니다.");
          });
      }

      // 일정 불러오기 함수
      function loadEvents(userId) {
        axios.get(`/api/events?userId=${userId}`).then((response) => {
          const calendar = document.getElementById("calendar");
          calendar.innerHTML = ""; // 기존 일정 초기화

          // 서버로부터 받은 이벤트 데이터가 비어있을 경우 처리
          if (response.data.events.length === 0) {
            const emptyMessage = document.createElement("div");
            emptyMessage.className = "alert alert-info";
            emptyMessage.textContent = "등록된 일정이 없습니다.";
            calendar.appendChild(emptyMessage);
          } else {
            // 이벤트 데이터를 화면에 표시
            response.data.events.forEach((event) => {
              const eventItem = document.createElement("div");
              eventItem.className = "event-item border p-2 mb-2";
              eventItem.innerHTML = `
                        <strong>${event.date}</strong> - ${event.title} (${event.startTime} ~ ${event.endTime})
                        <button class="btn btn-danger btn-sm float-end" onclick="deleteEvent('${event._id}')">삭제</button>
                    `;
              calendar.appendChild(eventItem);
            });
          }
        });
      }
    </script>
  </body>
</html>
